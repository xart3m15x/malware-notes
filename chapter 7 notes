//analyzing malicious windows programs

- Most malware target Windows platforms and interacts closely with the OS
- Malware is typically poorly formed and tends to perform unexpected actions

Windows API
- Broad set of functionality that governs the way that malware interacts with the Microsoft libraries
- DWORD represent 32-bit unsigned integers
- WORD represent 16-bit unsigned integers
- Standard C types like int, short, and unsigned int are not normally used
- Hungarian notation for API function identifiers
  - Uses a prefix naming scheme that makes it easy to identify a variable's type
  - Variables that contain a 32-bit unsigned integer (DWORD) start with dw
    - I.E. dwSize
- Most common Window API types
  - WORD (w)
    - a 16-bit unsigned value
  - DWORD (dw)
    - a double-WORD, 32-bit unsigned value
  - Handles (H)
    - Reference to an object
    - Information stored here is not documented
    - Handle should be manipulated only by the Windows API
  - Long Pointer (LP)
    - Pointer to another type
    - Strings are usually prefixed with LP (LPSTR) because they are actually pointers
    - Sometimes will see Pointer (P)
    - Difference was only meaningful in 16-bit systems
   - Callback
    - Represents a function that will be called by the Windows API
- Handles are items that have been opened or created in the OS
  - I.E. a window, process, module, etc.
  - Similar to pointers in that they refer to an object or memory location somewhere else
    - BUT cannot be used in arithmetic operations
    - Also do not always represent the object's address
- Some functions return handles that represent values that can be used as pointers or arithmetic values
- Most common way that malware interacts with the system is by creating or modifying files
  - I.E. if malware creates a file and stores web-browsing habits in that file, the program is probably some form of spyware
  - Functions for accessing the file system:
    - CreateFile
      - Create and open files
      - Can open existing files, pipes, streams, and I/O devices
      - dwCreationDisposition controls whether the CreateFile function creates a new file or opens an existing one
    - ReadFile and WriteFile
      - Reading and writing to files
      - Both operate on files as a stream
      - When ReadFile is called, it reads only the first several bytes from a file
        - Once it is called again, it reads the next several bytes of the file, etc.
    - CreatefileMapping and MapViewOfFile
      - File mappings are commonly used by malware authors because they allow a file to be loaded into memory and manipulated easily
      - CreateFileMapping function loads a file from disk into memory
      - MapViewOfFile returns a pointer to the base address of the mapping
        - Can be used to access the file in memory
        - Can also read/write anywhere in the file
      - Commonly used to replicate the functionality of the Windows loader
        - Malware can parse the PE header and make changes to the file in memory
          - Causes the file to be executed as if it had been loaded by the OS loader
- Windows has a number of file types that can be accessed like regular files, but are not accessed by drive letter/folder
  - Malware often uses special files
  - Some special files can be stealthier because they don't show up in directory listings
  - Can also provide greater access to system hardware and internal data
